<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>K√ºt√ºphanem Pro</title>
    <style>
        /* --- TEMA VE SIFIRLAMA --- */
        :root {
            --bg-color: #121212;
            --card-bg: #1c1c1e;
            --text-main: #ffffff;
            --text-dim: #8e8e93;
            --accent: #0a84ff;
            --success: #32d74b;
            --warning: #ffd60a;
            --danger: #ff453a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-color); margin: 0; padding: 0; color: var(--text-main);
            -webkit-tap-highlight-color: transparent; padding-bottom: 90px;
        }

        /* NUMARA BUTONLARINI (SPINNER) KALDIRMA */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* HEADER */
        .header {
            background-color: rgba(28, 28, 30, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky; top: 0; z-index: 100; padding-top: env(safe-area-inset-top);
        }
        .header h1 { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }

        /* ANA EKRAN PANELƒ∞ */
        .main-stats { display: flex; gap: 12px; margin: 15px 20px; }
        .stat-box { flex: 1; background: var(--card-bg); padding: 12px; border-radius: 14px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .stat-box b { display: block; font-size: 22px; color: var(--accent); margin-bottom: 2px; }
        .stat-box span { font-size: 10px; color: var(--text-dim); text-transform: uppercase; font-weight: 600; }

        /* KONTROLLER */
        .controls { padding: 0 20px; margin-bottom: 15px; }
        .search-box { width: 100%; height: 46px; padding: 0 15px; border-radius: 10px; border: none; background: var(--card-bg); color: white; font-size: 16px; outline: none; box-sizing: border-box; }

        /* Lƒ∞STE TASARIMI */
        .container { padding: 0 20px; max-width: 600px; margin: 0 auto; }
        .book-item {
            background: var(--card-bg); padding: 15px; border-radius: 16px; margin-bottom: 10px;
            display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .book-icon { width: 44px; height: 44px; background: #2c2c2e; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 22px; }
        .book-info { flex: 1; overflow: hidden; }
        .book-title { font-size: 17px; font-weight: 600; color: white; margin-bottom: 2px; }
        .book-author { font-size: 14px; color: var(--text-dim); }

        /* YAZAR GRID */
        .author-tile {
            background: var(--card-bg); padding: 20px 10px; border-radius: 16px; text-align: center;
            border: 1px solid rgba(255,255,255,0.05); cursor: pointer;
            display: flex; flex-direction: column; justify-content: center; min-height: 80px;
        }
        .tile-name { font-size: 16px; font-weight: 700; color: white; margin-bottom: 6px; }
        .tile-count { font-size: 13px; color: var(--accent); font-weight: 800; }

        /* PROFƒ∞L SAYFASI */
        .profile-card { background: var(--card-bg); margin: 15px 0; padding: 15px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.05); }
        .progress-bar { height: 8px; background: #2c2c2e; border-radius: 4px; overflow: hidden; display: flex; }
        .progress-fill { height: 100%; transition: width 0.5s ease; }

        /* TAB BAR */
        .tab-bar { 
            position: fixed; bottom: 0; width: 100%; background: rgba(28, 28, 30, 0.98); 
            backdrop-filter: blur(25px); display: flex; justify-content: space-around; 
            padding-bottom: env(safe-area-inset-bottom); padding-top: 8px; height: 55px;
            border-top: 1px solid rgba(255,255,255,0.12); z-index: 1000;
        }
        .tab-btn { background: none; border: none; padding: 0; color: var(--text-dim); text-align: center; flex: 1; outline: none; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .tab-btn.active { color: var(--accent); }
        .tab-ico { font-size: 24px; display: block; }
        .tab-btn span:last-child { font-size: 11px; font-weight: 700; display: block; margin-top: 2px; }

        /* EKLEME EKRANI (ISBN D√úZENLENDƒ∞) */
        .isbn-container {
            display: flex; gap: 8px; margin-bottom: 20px;
        }
        .isbn-input-pro {
            flex: 1; height: 50px; background: #2c2c2e; border: 1px solid #3a3a3c;
            border-radius: 12px; color: white; font-size: 18px; text-align: center;
            outline: none; -webkit-appearance: none;
        }
        .isbn-input-pro:focus { border-color: var(--accent); }

        .btn-magic-pro {
            width: 70px; height: 50px; background: var(--warning); color: black;
            border: none; border-radius: 12px; font-size: 22px; cursor: pointer;
        }

        /* MODALLAR */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 200; align-items: flex-end; }
        .modal-content { background: #1c1c1e; width: 100%; border-radius: 25px 25px 0 0; padding: 25px; box-sizing: border-box; max-height: 90vh; overflow-y: auto; }
        .btn-primary { width: 100%; background: var(--accent); color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 700; font-size: 16px; }
        .input-std { width: 100%; background: #2c2c2e; border: 1px solid #3a3a3c; padding: 14px; border-radius: 12px; color: white; margin-bottom: 12px; box-sizing: border-box; font-size: 16px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="header"><h1 id="header-title">K√ºt√ºphanem üìö</h1></div>

    <div id="page-library">
        <div class="main-stats">
            <div class="stat-box"><b id="main-total-count">0</b><span>Kitap</span></div>
            <div class="stat-box"><b id="main-author-count">0</b><span>Yazar</span></div>
        </div>
        <div class="controls"><input type="text" id="search-input" class="search-box" placeholder="Hƒ±zlƒ± Ara..." onkeyup="applyFilters()"></div>
        <div class="container" id="book-list"></div>
    </div>

    <div id="page-authors" class="container hidden" style="margin-top: 20px;">
        <div id="authors-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;"></div>
    </div>

    <div id="page-profile" class="container hidden" style="margin-top: 20px;">
        <div style="text-align:center; margin-bottom: 25px;">
            <div style="width: 70px; height: 70px; background: var(--accent); border-radius: 50%; margin: 0 auto 12px auto; display: flex; align-items: center; justify-content: center; font-size: 26px;">üë§</div>
            <h2 style="margin:0;">Okuma Profilim</h2>
        </div>
        <div class="profile-card">
            <h4 style="margin:0 0 12px 0; font-size: 14px;">üìä Okuma Daƒüƒ±lƒ±mƒ±</h4>
            <div class="progress-bar">
                <div id="bar-read" class="progress-fill" style="background:var(--success); width: 0%"></div>
                <div id="bar-reading" class="progress-fill" style="background:var(--accent); width: 0%"></div>
                <div id="bar-todo" class="progress-fill" style="background:var(--warning); width: 0%"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 12px; font-size: 11px; font-weight: 600;">
                <span style="color:var(--success)">Bitti: <span id="stat-read-val">0</span></span>
                <span style="color:var(--accent)">Okuyor: <span id="stat-reading-val">0</span></span>
                <span style="color:var(--warning)">Bekliyor: <span id="stat-todo-val">0</span></span>
            </div>
        </div>
        <div class="profile-card" style="text-align:center;">
            <button class="btn-primary" style="background: #2c2c2e; padding: 12px;" onclick="pickRandomBook()">üé≤ Rastgele √ñner</button>
        </div>
    </div>

    <div id="page-login" class="container hidden" style="text-align: center; padding-top: 40px;">
        <div style="font-size: 40px; margin-bottom: 20px;">üîê</div>
        <input type="number" id="pin-input" placeholder="≈ûifre" inputmode="numeric" class="input-std" style="text-align: center; width: 140px;">
        <button class="btn-primary" onclick="checkLogin()">Giri≈ü</button>
    </div>

    <div id="page-add" class="container hidden" style="padding-top: 15px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Kitap Ekle</h3>
            <span onclick="logout()" style="color:var(--danger); font-weight:700; cursor:pointer; font-size:12px;">ƒ∞PTAL</span>
        </div>
        
        <label style="font-size:12px; color:var(--text-dim); margin-bottom:8px; display:block; font-weight:600;">BARKOD ƒ∞LE SORGULA</label>
        <div class="isbn-container">
            <input type="number" id="isbn-input" class="isbn-input-pro" placeholder="ISBN No Girin" 
                   inputmode="numeric" pattern="[0-9]*">
            <button class="btn-magic-pro" onclick="fetchByISBN()">ü™Ñ</button>
        </div>
        
        <label style="font-size:12px; color:var(--text-dim); margin-bottom:8px; display:block; font-weight:600;">MANUEL Bƒ∞LGƒ∞LER</label>
        <input type="text" id="title-input" placeholder="Kitap Adƒ±" class="input-std">
        <input type="text" id="author-input" placeholder="Yazar Adƒ±" class="input-std">
        <button id="save-btn" class="btn-primary" onclick="saveBook()">KAYDET</button>
    </div>

    <div id="detail-modal" class="modal-overlay" onclick="closeModal(event, 'detail-modal')">
        <div class="modal-content">
            <span style="float:right; color:var(--accent); font-weight:bold;" onclick="toggleModal('detail-modal', false)">Kapat</span>
            <div id="detail-modal-body"></div>
            <div style="display:flex; gap:10px; margin-top:25px;">
                <button class="btn-primary" style="background:var(--warning); color:black; font-size:12px; padding:10px;" onclick="updateBookStatus('todo')">Bekliyor</button>
                <button class="btn-primary" style="background:var(--accent); font-size:12px; padding:10px;" onclick="updateBookStatus('reading')">Okuyor</button>
                <button class="btn-primary" style="background:var(--success); color:black; font-size:12px; padding:10px;" onclick="updateBookStatus('read')">Okundu</button>
            </div>
        </div>
    </div>

    <div id="author-modal" class="modal-overlay" onclick="closeModal(event, 'author-modal')">
        <div class="modal-content"><span style="float:right; color:var(--accent); font-weight:bold;" onclick="toggleModal('author-modal', false)">Kapat</span><div id="author-modal-body"></div></div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" id="tab-library" onclick="switchTab('library')"><span class="tab-ico">üìö</span><span>Kitaplƒ±k</span></button>
        <button class="tab-btn" id="tab-authors" onclick="switchTab('authors')"><span class="tab-ico">üë§</span><span>Yazarlar</span></button>
        <button class="tab-btn" id="tab-profile" onclick="switchTab('profile')"><span class="tab-ico">üìä</span><span>Profil</span></button>
        <button class="tab-btn" id="tab-add" onclick="switchTab('add')"><span class="tab-ico">‚ûï</span><span>Ekle</span></button>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycby7oenOOtjnNkDTQs7G8HdaLkekcQyhhutWpELd_6LtAJ-qc9J6qnUQvthCWVgmzuqibg/exec";
        const ADMIN_PIN = "5555";
        let allBooks = [];
        let bookStatuses = {};
        let currentDetailBook = null;
        let isLoggedIn = false;

        window.onload = function() {
            const savedStatuses = localStorage.getItem('kutuphanem_statuses');
            if (savedStatuses) bookStatuses = JSON.parse(savedStatuses);
            const cached = localStorage.getItem('kutuphanem_data');
            if (cached) { allBooks = JSON.parse(cached); refreshUI(); }
            fetchBooks();
        };

        function fetchBooks() {
            fetch(API_URL).then(res => res.json()).then(data => {
                allBooks = data.map(b => ({ ad: b.ad.trim(), yazar: b.yazar.trim() }))
                               .sort((a,b) => a.ad.localeCompare(b.ad, 'tr'));
                localStorage.setItem('kutuphanem_data', JSON.stringify(allBooks));
                refreshUI();
            });
        }

        function refreshUI() {
            const total = allBooks.length;
            const authorsCount = new Set(allBooks.map(b => b.yazar)).size;
            document.getElementById('main-total-count').innerText = total;
            document.getElementById('main-author-count').innerText = authorsCount;

            let stats = { todo: 0, reading: 0, read: 0 };
            allBooks.forEach(b => {
                const s = bookStatuses[`${b.ad}-${b.yazar}`];
                if (s) stats[s]++;
            });

            document.getElementById('stat-read-val').innerText = stats.read;
            document.getElementById('stat-reading-val').innerText = stats.reading;
            document.getElementById('stat-todo-val').innerText = stats.todo;

            if (total > 0) {
                document.getElementById('bar-read').style.width = (stats.read / total * 100) + "%";
                document.getElementById('bar-reading').style.width = (stats.reading / total * 100) + "%";
                document.getElementById('bar-todo').style.width = (stats.todo / total * 100) + "%";
            }
            applyFilters();
            renderAuthorsPage();
        }

        function applyFilters() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const filtered = allBooks.filter(b => b.ad.toLowerCase().includes(q) || b.yazar.toLowerCase().includes(q));
            renderBooks(filtered);
        }

        function renderBooks(bks) {
            const list = document.getElementById('book-list');
            list.innerHTML = '';
            bks.forEach(b => {
                const status = bookStatuses[`${b.ad}-${b.yazar}`] || "";
                const dot = status ? `<div style="width:8px; height:8px; border-radius:50%; margin-left:8px; background:var(--${status==='todo'?'warning':status==='read'?'success':'accent'})"></div>` : "";
                const div = document.createElement('div');
                div.className = 'book-item';
                div.onclick = () => showBookDetail(b);
                div.innerHTML = `<div class="book-icon">üìñ</div><div class="book-info"><div class="book-title">${b.ad}</div><div class="book-author">${b.yazar}</div></div>${dot}`;
                list.appendChild(div);
            });
        }

        function showBookDetail(b) {
            currentDetailBook = b;
            const body = document.getElementById('detail-modal-body');
            body.innerHTML = '<p style="text-align:center;">Aranƒ±yor...</p>';
            toggleModal('detail-modal', true);

            fetch(`https://www.googleapis.com/books/v1/volumes?q=intitle:${b.ad}+inauthor:${b.yazar}&maxResults=1`)
            .then(res => res.json()).then(data => {
                let img = '', pc = '-', yr = '-', ds = 'Bilgi bulunamadƒ±.';
                if (data.items) {
                    const i = data.items[0].volumeInfo;
                    img = i.imageLinks?.thumbnail.replace('http:', 'https:') || '';
                    pc = i.pageCount || '-';
                    yr = i.publishedDate?.substring(0,4) || '-';
                    ds = i.description || ds;
                }
                body.innerHTML = `
                    <div style="text-align:center; margin-top:15px;">
                        ${img ? `<img src="${img}" style="width:110px; border-radius:10px; box-shadow: 0 8px 16px rgba(0,0,0,0.4);">` : ''}
                        <h2 style="margin:15px 0 5px 0; font-size:20px;">${b.ad}</h2>
                        <p style="color:var(--text-dim); font-size:16px;">${b.yazar}</p>
                    </div>
                    <div style="display:flex; justify-content:center; gap:20px; margin:15px 0; font-size:13px;">
                        <div><b>${pc}</b> Sayfa</div><div><b>${yr}</b> Basƒ±m</div>
                    </div>
                    <div style="font-size:14px; color:#ccc; line-height:1.5; background:#2c2c2e; padding:12px; border-radius:12px; max-height:150px; overflow:auto;">${ds}</div>
                `;
            });
        }

        function updateBookStatus(status) {
            const key = `${currentDetailBook.ad}-${currentDetailBook.yazar}`;
            if (bookStatuses[key] === status) delete bookStatuses[key];
            else bookStatuses[key] = status;
            localStorage.setItem('kutuphanem_statuses', JSON.stringify(bookStatuses));
            toggleModal('detail-modal', false);
            refreshUI();
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + t).classList.add('active');
            ['page-library', 'page-authors', 'page-profile', 'page-login', 'page-add'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if (t === 'add' && !isLoggedIn) document.getElementById('page-login').classList.remove('hidden');
            else document.getElementById('page-' + t).classList.remove('hidden');
        }

        function saveBook() {
            const ad = document.getElementById('title-input').value.trim();
            const yazar = document.getElementById('author-input').value.trim();
            if (!ad || !yazar) return;
            if (allBooks.some(b => b.ad.toLowerCase() === ad.toLowerCase() && b.yazar.toLowerCase() === yazar.toLowerCase())) {
                alert("Zaten mevcut!"); return;
            }
            const btn = document.getElementById('save-btn');
            btn.disabled = true; btn.innerText = 'Ekleniyor...';
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ ad, yazar }) })
            .then(() => {
                document.getElementById('title-input').value = '';
                document.getElementById('author-input').value = '';
                fetchBooks();
                alert("Eklendi!");
            }).finally(() => { btn.disabled = false; btn.innerText = 'KAYDET'; });
        }

        function checkLogin() { if(document.getElementById('pin-input').value === ADMIN_PIN) { isLoggedIn = true; switchTab('add'); } else alert("Yanlƒ±≈ü!"); }
        function logout() { isLoggedIn = false; switchTab('profile'); }
        function toggleModal(id, s) { document.getElementById(id).style.display = s ? 'flex' : 'none'; }
        function closeModal(e, id) { if(e.target.id === id) toggleModal(id, false); }
        function renderAuthorsPage() { const grid = document.getElementById('authors-grid'); grid.innerHTML = ''; const g = {}; allBooks.forEach(b => { if(!g[b.yazar]) g[b.yazar]=[]; g[b.yazar].push(b); }); Object.keys(g).sort().forEach(a => { const div = document.createElement('div'); div.className='author-tile'; div.onclick=()=>openAuthorBooks(a, g[a]); div.innerHTML=`<div class="tile-name">${a}</div><div class="tile-count">${g[a].length} Kitap</div>`; grid.appendChild(div); }); }
        function openAuthorBooks(a, bks) { const b = document.getElementById('author-modal-body'); b.innerHTML=`<h2 style="text-align:center">${a}</h2>`; bks.forEach(bk=>{ const div = document.createElement('div'); div.className='book-item'; div.onclick=()=>showBookDetail(bk); div.innerHTML=`<div class="book-icon">üìñ</div><div class="book-info"><div class="book-title">${bk.ad}</div></div>`; b.appendChild(div); }); toggleModal('author-modal', true); }
        function pickRandomBook() { if(allBooks.length===0) return; const b = allBooks[Math.floor(Math.random()*allBooks.length)]; alert("üé≤ Tavsiyem:\n\n"+b.ad+"\n"+b.yazar); }
        function fetchByISBN() { const i = document.getElementById('isbn-input').value; if(i.length<5) return; fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${i}`).then(res=>res.json()).then(data=>{ if(data.items){ const v = data.items[0].volumeInfo; document.getElementById('title-input').value=v.title; document.getElementById('author-input').value=v.authors[0]; } }); }
    </script>
</body>
</html>
