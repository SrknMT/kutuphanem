<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>K√ºt√ºphanem Pro</title>
    <style>
        /* --- KURUMSAL TEMA --- */
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --header-footer-bg: rgba(28, 28, 30, 0.98);
            --text-main: #ffffff;
            --text-dim: #98989d;
            --accent: #0a84ff;
            --success: #30d158;
            --warning: #ffd60a;
            --danger: #ff453a;
            --border-color: rgba(255, 255, 255, 0.12);
            --bar-height: 60px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-color); margin: 0; padding: 0; color: var(--text-main);
            -webkit-tap-highlight-color: transparent; 
            padding-top: calc(var(--bar-height) + env(safe-area-inset-top));
            padding-bottom: calc(var(--bar-height) + env(safe-area-inset-bottom));
            overflow-x: hidden;
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .header {
            position: fixed; top: 0; left: 0; right: 0; height: var(--bar-height);
            background-color: var(--header-footer-bg); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            padding-top: env(safe-area-inset-top);
        }
        .header h1 { margin: 0; font-size: 18px; font-weight: 600; letter-spacing: -0.5px; }

        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        .content-area { padding: 20px; max-width: 600px; margin: 0 auto; min-height: 80vh; }
        .book-item {
            display: flex; align-items: center; padding: 15px; margin-bottom: 12px;
            background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color);
            transition: background 0.2s; cursor: pointer; position: relative;
        }
        .book-item:active { background: #2c2c2e; }
        .book-icon-box { 
            width: 45px; height: 60px; background: #333; border-radius: 4px; 
            display: flex; align-items: center; justify-content: center; margin-right: 15px;
            overflow: hidden; flex-shrink: 0; font-size: 24px;
        }
        .book-icon-box img { width: 100%; height: 100%; object-fit: cover; }
        .book-details { flex: 1; overflow: hidden; }
        .book-title { font-size: 16px; font-weight: 600; color: white; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-author { font-size: 13px; color: var(--text-dim); }
        .read-badge { 
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            width: 12px; height: 12px; border-radius: 50%; background: var(--success);
            box-shadow: 0 0 10px rgba(48, 209, 88, 0.4); display: none;
        }
        .book-item.is-read .read-badge { display: block; }

        .modal-overlay {
            display: none; position: fixed; inset: 0; background: var(--bg-color);
            z-index: 2000; overflow-y: auto; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-header {
            position: sticky; top: 0; background: var(--header-footer-bg);
            height: var(--bar-height); display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; border-bottom: 1px solid var(--border-color); backdrop-filter: blur(20px);
            padding-top: env(safe-area-inset-top); z-index: 10;
        }
        .btn-nav { background: none; border: none; color: var(--accent); font-size: 16px; font-weight: 400; cursor: pointer; display: flex; align-items: center; gap: 5px;}
        .modal-body { padding: 25px 20px; max-width: 600px; margin: 0 auto; padding-bottom: 100px; }

        .author-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .author-card {
            background: var(--card-bg); padding: 20px 10px; border-radius: 16px; text-align: center;
            border: 1px solid var(--border-color); cursor: pointer; display: flex; flex-direction: column; align-items: center;
        }
        .author-img-box {
            width: 60px; height: 60px; border-radius: 50%; background: #333; margin-bottom: 10px;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--border-color); font-size: 24px;
        }
        .author-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .author-name { font-size: 15px; font-weight: 600; color: white; margin-bottom: 4px; line-height: 1.3; }
        .author-count { font-size: 12px; color: var(--text-dim); }

        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: var(--bar-height);
            background-color: var(--header-footer-bg); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color); z-index: 100;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .tab-btn { background: none; border: none; padding: 0; color: var(--text-dim); flex: 1; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .tab-btn.active { color: var(--accent); }
        .tab-btn span { font-size: 10px; font-weight: 600; margin-top: 4px; }

        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--border-color); text-align: center; margin-bottom: 15px;}
        .input-std { width: 100%; height: 50px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 0 15px; color: white; font-size: 16px; outline: none; box-sizing: border-box; margin-bottom: 15px;}
        .btn-main { width: 100%; height: 50px; background: var(--accent); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .hidden { display: none !important; }
        
        #toast-container { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 300px; text-align: center; pointer-events: none; }
        .toast { background: rgba(50,50,50,0.95); backdrop-filter: blur(10px); color: white; padding: 12px 20px; border-radius: 30px; font-size: 14px; margin-bottom: 10px; opacity: 0; transform: translateY(-20px) scale(0.9); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: inline-block; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); font-weight: 600;}
        .toast.show { opacity: 1; transform: translateY(0) scale(1); }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="header"><h1>K√ºt√ºphanem</h1></div>

    <div id="page-library" class="content-area">
        <div style="margin-bottom:20px; display:flex; gap:10px;">
            <input type="text" id="search-input" class="input-std" style="margin:0;" placeholder="Kitap veya yazar ara..." onkeyup="applyFilters()">
        </div>
        <div id="book-list"></div>
    </div>

    <div id="page-authors" class="content-area hidden">
        <div id="authors-grid" class="author-grid"></div>
    </div>

    <div id="page-profile" class="content-area hidden" style="text-align:center;">
        <div style="width:120px; height:120px; margin: 40px auto 20px; position: relative;">
            <svg viewBox="0 0 36 36" style="width:100%; height:100%; transform: rotate(-90deg);">
                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#333" stroke-width="3" />
                <path id="circle-progress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--success)" stroke-width="3" stroke-dasharray="0, 100" />
            </svg>
            <div style="position: absolute; top:50%; left:50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: bold;" id="percent-text">%0</div>
        </div>
        
        <div class="stats-row" style="display:flex; gap:15px;">
            <div class="stat-card" style="flex:1">
                <span style="font-size:30px; display:block; margin-bottom:5px;">üìö</span>
                <span id="stat-total" style="font-size:20px; font-weight:bold;">0</span>
                <span style="display:block; font-size:12px; color:var(--text-dim);">TOPLAM</span>
            </div>
            <div class="stat-card" style="flex:1; border-color:var(--success);">
                <span style="font-size:30px; display:block; margin-bottom:5px;">‚úÖ</span>
                <span id="stat-read" style="font-size:20px; font-weight:bold; color:var(--success);">0</span>
                <span style="display:block; font-size:12px; color:var(--text-dim);">OKUNDU</span>
            </div>
        </div>
        <button class="btn-main" style="background: #333; margin-top:20px;" onclick="pickRandomBook()">üé≤ Rastgele √ñneri</button>
    </div>

    <div id="page-login" class="content-area hidden" style="display:flex; flex-direction:column; justify-content:center; min-height:80vh;">
        <h2 style="text-align:center; margin-bottom:30px;">Y√∂netici Giri≈üi</h2>
        <input type="number" id="pin-input" class="input-std" style="text-align:center; letter-spacing:5px; font-size:24px;" placeholder="****" inputmode="numeric">
        <button class="btn-main" onclick="checkLogin()">Giri≈ü Yap</button>
    </div>

    <div id="page-add" class="content-area hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">Kitap Ekle</h2>
            <button onclick="logout()" style="background:none; border:none; color:var(--danger); font-weight:600;">√áƒ±kƒ±≈ü</button>
        </div>

        <div style="margin-bottom:20px;">
            <label style="font-size:12px; color:var(--text-dim); margin-bottom:5px; display:block;">ISBN BARKOD</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="isbn-input" class="input-std" style="margin:0;" placeholder="Barkod Tara/Yaz" inputmode="numeric">
                <button onclick="fetchByISBN()" style="width:60px; background:#333; border-radius:10px; border:1px solid #444; color:var(--accent); font-size:20px;">üîç</button>
            </div>
        </div>

        <label style="font-size:12px; color:var(--text-dim); margin-bottom:5px; display:block;">Kƒ∞TAP DETAYLARI</label>
        <input type="text" id="title-input" class="input-std" placeholder="Kitap Adƒ±">
        <input type="text" id="author-input" class="input-std" placeholder="Yazar Adƒ±">
        
        <button id="save-btn" class="btn-main" onclick="saveBook()">K√ºt√ºphaneye Kaydet</button>
    </div>

    <div id="full-modal" class="modal-overlay">
        <div class="modal-header">
            <button class="btn-nav" onclick="closeFullModal()"><svg class="icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg> Geri</button>
            <span id="modal-title" style="font-weight:600;">Detay</span>
            <button class="btn-nav" style="color:white;" onclick="closeFullModal()"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        </div>
        <div class="modal-body" id="modal-content"></div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" id="tab-library" onclick="switchTab('library')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
            <span>Kitaplƒ±k</span>
        </button>
        <button class="tab-btn" id="tab-authors" onclick="switchTab('authors')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span>Yazarlar</span>
        </button>
        <button class="tab-btn" id="tab-profile" onclick="switchTab('profile')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
            <span>Profil</span>
        </button>
        <button class="tab-btn" id="tab-add" onclick="switchTab('add')">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
            <span>Ekle</span>
        </button>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycby7oenOOtjnNkDTQs7G8HdaLkekcQyhhutWpELd_6LtAJ-qc9J6qnUQvthCWVgmzuqibg/exec"; 
        const ADMIN_PIN = "5555";
        let allBooks = [];
        let readBooks = [];
        let isLoggedIn = false;
        
        // √ñNBELLEK DEƒûƒ∞≈ûKENLERƒ∞
        let bookCache = {};
        let authorCache = {};

        const FUN_SUCCESS_MSGS = ["Bam! Hazineye eklendi üíé", "Harika se√ßim! Rafa koydum üìö", "Kitaplƒ±k ≈üenlendi! üéâ", "Bunu okumak i√ßin sabƒ±rsƒ±zlanƒ±yorum! ü§ì", "M√ºkemmel! Kaydedildi ‚úÖ"];
        const FUN_ERROR_MSGS = ["Olamaz! Bir ≈üeyler ters gitti üí•", "≈ûey... Bunu yapamadƒ±m üõë", "Houston, bir sorunumuz var üöÄ", "Bilgiler eksik kaptan! ‚ö†Ô∏è"];
        const FUN_SEARCH_MSGS = ["Dedektif i≈ü ba≈üƒ±nda... üïµÔ∏è‚Äç‚ôÇÔ∏è", "Raflarƒ± karƒ±≈ütƒ±rƒ±yorum... üßê", "Hemen buluyorum! ‚ö°"];

        window.onload = function() {
            if(localStorage.getItem('kutuphanem_read')) readBooks = JSON.parse(localStorage.getItem('kutuphanem_read'));
            if(localStorage.getItem('kutuphanem_data')) { allBooks = JSON.parse(localStorage.getItem('kutuphanem_data')); refreshUI(); }
            
            // √ñnbellekleri Y√ºkle
            if(localStorage.getItem('kutuphanem_book_cache')) bookCache = JSON.parse(localStorage.getItem('kutuphanem_book_cache'));
            if(localStorage.getItem('kutuphanem_author_cache')) authorCache = JSON.parse(localStorage.getItem('kutuphanem_author_cache'));

            fetchBooks();
        };

        function showToast(m, type='normal') {
            const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className='toast'; 
            if(type === 'random_success') t.innerText = FUN_SUCCESS_MSGS[Math.floor(Math.random() * FUN_SUCCESS_MSGS.length)];
            else if(type === 'random_error') t.innerText = FUN_ERROR_MSGS[Math.floor(Math.random() * FUN_ERROR_MSGS.length)];
            else if(type === 'random_search') t.innerText = FUN_SEARCH_MSGS[Math.floor(Math.random() * FUN_SEARCH_MSGS.length)];
            else t.innerText = m;
            c.appendChild(t); setTimeout(()=>t.classList.add('show'),50); setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300);},3000);
        }

        function cleanText(t) { return t.toString().trim().toLowerCase().replace(/ƒ±/g,'i').replace(/ƒü/g,'g').replace(/√º/g,'u').replace(/≈ü/g,'s').replace(/√∂/g,'o').replace(/√ß/g,'c'); }

        function fetchBooks() {
            fetch(API_URL).then(r=>r.json()).then(d=>{
                allBooks = d.map(b=>({ad:b.ad.trim(), yazar:b.yazar.trim()})).sort((a,b)=>a.ad.localeCompare(b.ad,'tr'));
                localStorage.setItem('kutuphanem_data', JSON.stringify(allBooks)); refreshUI();
            });
        }

        function refreshUI() {
            document.getElementById('stat-total').innerText = allBooks.length;
            document.getElementById('stat-read').innerText = readBooks.length;
            const percent = allBooks.length > 0 ? Math.round((readBooks.length / allBooks.length) * 100) : 0;
            document.getElementById('percent-text').innerText = `%${percent}`;
            document.getElementById('circle-progress').setAttribute('stroke-dasharray', `${percent}, 100`);
            applyFilters(); renderAuthorsPage();
        }

        function applyFilters() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const f = allBooks.filter(b=>b.ad.toLowerCase().includes(q) || b.yazar.toLowerCase().includes(q));
            renderBooks(f);
        }

        function renderBooks(list) {
            const c = document.getElementById('book-list'); c.innerHTML='';
            list.forEach(b=>{
                const isRead = readBooks.includes(`${b.ad}-${b.yazar}`);
                const cacheKey = `${b.ad}-${b.yazar}`;
                
                const div = document.createElement('div'); div.className = `book-item ${isRead ? 'is-read' : ''}`;
                div.onclick = () => showBookDetail(b);
                div.innerHTML = `
                    <div class="book-icon-box" id="thumb-${cacheKey.replace(/\s/g,'')}">üìö</div>
                    <div class="book-details"><div class="book-title">${b.ad}</div><div class="book-author">${b.yazar}</div></div>
                    <div class="read-badge"></div>
                `;
                c.appendChild(div);

                // √ñnbellek kontrol√º (Kapak Resmi)
                if(bookCache[cacheKey] && bookCache[cacheKey].img) {
                     div.querySelector('.book-icon-box').innerHTML = `<img src="${bookCache[cacheKey].img}">`;
                } else {
                    fetch(`https://www.googleapis.com/books/v1/volumes?q=intitle:${b.ad}+inauthor:${b.yazar}&maxResults=1`)
                    .then(r=>r.json()).then(d=>{
                        if(d.items && d.items[0].volumeInfo.imageLinks) {
                            const img = d.items[0].volumeInfo.imageLinks.thumbnail.replace('http:','https:');
                            div.querySelector('.book-icon-box').innerHTML = `<img src="${img}">`;
                            
                            // Cache'e kaydet (sadece resim URL)
                            if(!bookCache[cacheKey]) bookCache[cacheKey] = {};
                            bookCache[cacheKey].img = img;
                            localStorage.setItem('kutuphanem_book_cache', JSON.stringify(bookCache));
                        }
                    });
                }
            });
        }

        function showBookDetail(b) {
            const isRead = readBooks.includes(`${b.ad}-${b.yazar}`);
            const btnText = isRead ? "Okunmadƒ± Olarak ƒ∞≈üaretle" : "Okundu Olarak ƒ∞≈üaretle";
            const btnColor = isRead ? "#333" : "var(--success)";
            const cacheKey = `${b.ad}-${b.yazar}`;

            // Varsayƒ±lan HTML
            let html = `
                <div style="text-align:center;">
                    <div id="modal-cover" style="width:140px; height:210px; background:#333; margin:0 auto 20px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:40px; overflow:hidden;">üìö</div>
                    <h2 style="font-size:24px; font-weight:700; margin-bottom:5px;">${b.ad}</h2>
                    <span style="font-size:16px; color:var(--accent); font-weight:500;">${b.yazar}</span>
                </div>
                <button onclick="toggleReadStatus('${b.ad}', '${b.yazar}')" style="width:100%; padding:15px; background:${btnColor}; color:white; border:none; border-radius:12px; font-weight:600; margin:25px 0 25px;">${btnText}</button>
                <h4 style="color:var(--text-dim); margin-bottom:10px;">√ñZET</h4>
                <div id="modal-desc" style="font-size:15px; line-height:1.6; color:#ccc;">Y√ºkleniyor...</div>
            `;
            openFullModal("Kitap Detayƒ±", html);

            // √ñnbellek kontrol√º (Detaylar)
            if(bookCache[cacheKey] && bookCache[cacheKey].desc) {
                if(bookCache[cacheKey].img) document.getElementById('modal-cover').innerHTML = `<img src="${bookCache[cacheKey].img}" style="width:100%; height:100%; border-radius:12px; object-fit:cover;">`;
                document.getElementById('modal-desc').innerText = bookCache[cacheKey].desc;
            } else {
                fetch(`https://www.googleapis.com/books/v1/volumes?q=intitle:${b.ad}+inauthor:${b.yazar}&maxResults=1`)
                .then(r=>r.json()).then(d=>{
                    let desc = "√ñzet bulunamadƒ±.";
                    let img = null;
                    if(d.items) {
                        const i = d.items[0].volumeInfo;
                        if(i.imageLinks) {
                            img = i.imageLinks.thumbnail.replace('http:','https:');
                            document.getElementById('modal-cover').innerHTML = `<img src="${img}" style="width:100%; height:100%; border-radius:12px; object-fit:cover;">`;
                        }
                        desc = i.description || desc;
                        document.getElementById('modal-desc').innerText = desc;

                        // Cache'e kaydet
                        if(!bookCache[cacheKey]) bookCache[cacheKey] = {};
                        bookCache[cacheKey].desc = desc;
                        if(img) bookCache[cacheKey].img = img;
                        localStorage.setItem('kutuphanem_book_cache', JSON.stringify(bookCache));

                    } else { document.getElementById('modal-desc').innerText = "Bilgi bulunamadƒ±."; }
                });
            }
        }

        function renderAuthorsPage() {
            const grid = document.getElementById('authors-grid'); grid.innerHTML=''; const g={};
            allBooks.forEach(b=>{ if(!g[b.yazar]) g[b.yazar]=[]; g[b.yazar].push(b); });
            
            Object.keys(g).sort().forEach((a, index) => {
                const div = document.createElement('div'); div.className='author-card'; div.onclick=()=>showAuthorDetail(a, g[a]);
                div.innerHTML = `
                    <div class="author-img-box" id="auth-img-${index}">üë§</div>
                    <div class="author-name">${a}</div>
                    <div class="author-count">${g[a].length} Kitap</div>
                `;
                grid.appendChild(div);

                // Yazar fotoƒürafƒ± (√ñnbellekli)
                if(authorCache[a] && authorCache[a].img) {
                    document.getElementById(`auth-img-${index}`).innerHTML = `<img src="${authorCache[a].img}">`;
                } else {
                    fetch(`https://tr.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(a)}`)
                    .then(r=>r.json()).then(d=>{
                        if(d.thumbnail) {
                            const img = d.thumbnail.source;
                            document.getElementById(`auth-img-${index}`).innerHTML = `<img src="${img}">`;
                            
                            if(!authorCache[a]) authorCache[a] = {};
                            authorCache[a].img = img;
                            localStorage.setItem('kutuphanem_author_cache', JSON.stringify(authorCache));
                        }
                    }).catch(()=>{});
                }
            });
        }

        function showAuthorDetail(name, books) {
            let booksHtml = '';
            books.forEach(b => {
                const isRead = readBooks.includes(`${b.ad}-${b.yazar}`);
                booksHtml += `<div class="book-item" onclick="closeFullModal(); setTimeout(()=>showBookDetail({ad:'${b.ad}', yazar:'${b.yazar}'}),300)">
                    <div style="flex:1;"><div class="book-title">${b.ad}</div></div>
                    ${isRead ? '‚úÖ' : ''}
                </div>`;
            });

            let html = `
                <div style="text-align:center; margin-bottom:30px;">
                    <div id="bio-img" style="width:100px; height:100px; background:#333; border-radius:50%; margin:0 auto 15px; overflow:hidden; display:flex; align-items:center; justify-content:center; font-size:40px;">üë§</div>
                    <h2 style="margin:0;">${name}</h2>
                </div>
                <div id="bio-text" style="font-size:14px; color:#ccc; line-height:1.5; margin-bottom:30px; background:var(--card-bg); padding:15px; border-radius:12px;">Biyografi y√ºkleniyor...</div>
                <h4 style="color:var(--text-dim); margin-bottom:15px;">Kƒ∞TAPLARI (${books.length})</h4>
                ${booksHtml}
            `;
            openFullModal(name, html);

            // Biyografi (√ñnbellekli)
            if(authorCache[name] && authorCache[name].bio) {
                document.getElementById('bio-text').innerText = authorCache[name].bio;
                if(authorCache[name].img) document.getElementById('bio-img').innerHTML = `<img src="${authorCache[name].img}" style="width:100%; height:100%; object-fit:cover;">`;
            } else {
                fetch(`https://tr.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(name)}`)
                .then(r=>r.json()).then(d=>{
                    let bio = "Biyografi bulunamadƒ±.";
                    let img = null;
                    if(d.extract) {
                        bio = d.extract;
                        document.getElementById('bio-text').innerText = bio;
                        if(d.thumbnail) {
                            img = d.thumbnail.source;
                            document.getElementById('bio-img').innerHTML = `<img src="${img}" style="width:100%; height:100%; object-fit:cover;">`;
                        }

                        if(!authorCache[name]) authorCache[name] = {};
                        authorCache[name].bio = bio;
                        if(img) authorCache[name].img = img;
                        localStorage.setItem('kutuphanem_author_cache', JSON.stringify(authorCache));
                    } else { document.getElementById('bio-text').innerText = bio; }
                }).catch(()=>document.getElementById('bio-text').innerText = "Biyografi alƒ±namadƒ±.");
            }
        }

        function toggleReadStatus(ad, yazar) {
            const key = `${ad}-${yazar}`;
            if(readBooks.includes(key)) readBooks = readBooks.filter(k => k !== key);
            else readBooks.push(key);
            localStorage.setItem('kutuphanem_read', JSON.stringify(readBooks));
            showToast("Durum g√ºncellendi ‚ú®");
            closeFullModal(); refreshUI();
        }

        // --- GELƒ∞≈ûMƒ∞≈û ISBN SORGULAMA VE D√úZELTME ---
        function fetchByISBN() {
            let i = document.getElementById('isbn-input').value;
            // ISBN temizleme (bo≈üluk ve tireleri sil)
            i = i.replace(/[^0-9]/g, '');

            if (i.length < 10) {
                showToast("Ge√ßerli bir ISBN girin", "random_error");
                return;
            }

            showToast("", "random_search");

            const performSearch = (isbn, isRetry = false) => {
                fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`)
                .then(r=>r.json()).then(data=>{
                    if(data.items){
                        const v = data.items[0].volumeInfo;
                        document.getElementById('title-input').value = v.title;
                        document.getElementById('author-input').value = v.authors ? v.authors[0] : '';
                        showToast("Buldum! ƒ∞≈üte bilgiler ü™Ñ");
                    } else {
                        if (!isRetry) {
                            // ƒ∞lk denemede bulamazsa 1 saniye sonra tekrar dene
                            setTimeout(() => performSearch(isbn, true), 1000);
                        } else {
                            showToast("Maalesef bulamadƒ±m üõë");
                        }
                    }
                }).catch(() => {
                    if (!isRetry) setTimeout(() => performSearch(isbn, true), 1000);
                    else showToast("Baƒülantƒ± hatasƒ± ‚ö†Ô∏è");
                });
            };

            performSearch(i);
        }

        function saveBook() {
            const t = document.getElementById('title-input').value.trim();
            const a = document.getElementById('author-input').value.trim();
            
            if(!t || !a) return showToast("Eksik bilgi var!", "random_error");
            if(allBooks.find(b=>cleanText(b.ad)===cleanText(t))) {
                if(!confirm("Bu kitap zaten var. Yine de eklensin mi?")) return;
            }

            const btn = document.getElementById('save-btn'); btn.innerText="Kaydediliyor..."; btn.disabled=true;
            fetch(API_URL, {method:'POST', body:JSON.stringify({ad:t, yazar:a})}).then(()=>{
                showToast("", "random_success"); 
                document.getElementById('title-input').value=''; document.getElementById('author-input').value=''; 
                document.getElementById('isbn-input').value='';
                fetchBooks();
            }).finally(()=>{ btn.innerText="K√ºt√ºphaneye Kaydet"; btn.disabled=false; });
        }

        function openFullModal(title, content) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('full-modal').style.display = 'block';
        }
        function closeFullModal() { document.getElementById('full-modal').style.display = 'none'; }
        
        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active');
            document.querySelectorAll('.content-area').forEach(d=>d.classList.add('hidden'));
            if(t==='add' && !isLoggedIn) document.getElementById('page-login').classList.remove('hidden');
            else document.getElementById('page-'+t).classList.remove('hidden');
        }
        function checkLogin(){ if(document.getElementById('pin-input').value===ADMIN_PIN){ isLoggedIn=true; switchTab('add'); } else showToast("Hatalƒ± ≈ûifre"); }
        function logout(){ isLoggedIn=false; switchTab('library'); }
        function pickRandomBook() { if(allBooks.length===0) return; showBookDetail(allBooks[Math.floor(Math.random()*allBooks.length)]); }
    </script>
</body>
</html>
