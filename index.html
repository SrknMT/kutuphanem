<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>K√ºt√ºphanem Pro</title>
    <style>
        /* --- TEMA --- */
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --text-main: #ffffff;
            --text-dim: #8e8e93;
            --accent: #0a84ff;
            --success: #32d74b;
            --warning: #ffd60a;
            --danger: #ff453a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-color); margin: 0; padding: 0; color: var(--text-main);
            -webkit-tap-highlight-color: transparent; padding-bottom: 90px;
            overflow-x: hidden;
        }

        /* NUMARA BUTONLARINI (SPINNER) KALDIRMA */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* TOAST Bƒ∞LDƒ∞Rƒ∞M */
        #toast-container {
            position: fixed; top: 60px; left: 50%; transform: translateX(-50%);
            z-index: 10000; width: 85%; max-width: 350px; pointer-events: none;
        }
        .toast {
            background: rgba(44, 44, 46, 0.98); backdrop-filter: blur(15px);
            color: white; padding: 15px 20px; border-radius: 20px;
            margin-bottom: 12px; text-align: center; font-size: 14px; font-weight: 600;
            box-shadow: 0 15px 35px rgba(0,0,0,0.6);
            transform: translateY(-120px); opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-bottom: 3px solid var(--success); }
        .toast.error { border-bottom: 3px solid var(--danger); }
        .toast.warning { border-bottom: 3px solid var(--warning); color: var(--warning); }

        /* HEADER */
        .header {
            background-color: rgba(28, 28, 30, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky; top: 0; z-index: 100; padding-top: env(safe-area-inset-top);
        }

        /* ƒ∞STATƒ∞STƒ∞KLER */
        .main-stats { display: flex; gap: 12px; margin: 15px 20px; }
        .stat-box { flex: 1; background: var(--card-bg); padding: 15px; border-radius: 18px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .stat-box b { display: block; font-size: 24px; color: var(--accent); }

        /* ARAMA */
        .controls { padding: 0 20px; margin-bottom: 15px; }
        .search-box { width: 100%; height: 50px; padding: 0 15px; border-radius: 12px; border: none; background: var(--card-bg); color: white; font-size: 16px; outline: none; box-sizing: border-box; }

        /* Kƒ∞TAP √ñƒûESƒ∞ */
        .container { padding: 0 20px; max-width: 600px; margin: 0 auto; }
        .book-item {
            background: var(--card-bg); padding: 16px; border-radius: 18px; margin-bottom: 10px;
            display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.05);
        }
        .book-item:active { transform: scale(0.97); background: #2c2c2e; }
        .book-info { flex: 1; margin-left: 15px; overflow: hidden; }
        .book-title { font-size: 17px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-author { font-size: 13px; color: var(--text-dim); margin-top: 2px; }

        /* MODAL */
        .modal-overlay { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(15px); z-index: 2000; align-items: flex-end; 
        }
        .modal-content { 
            background: #1c1c1e; width: 100%; border-radius: 30px 30px 0 0; 
            padding: 30px 25px; box-sizing: border-box; max-height: 95vh; 
            overflow-y: auto; position: relative;
        }
        .modal-drag-handle { width: 40px; height: 5px; background: #3a3a3c; border-radius: 10px; margin: -15px auto 20px auto; }

        /* YAZAR KARTLARI */
        .author-tile {
            background: var(--card-bg); padding: 25px 15px; border-radius: 20px; text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .tile-name { font-size: 16px; font-weight: 700; margin-bottom: 5px; }

        /* TAB BAR */
        .tab-bar { 
            position: fixed; bottom: 0; width: 100%; background: rgba(28, 28, 30, 0.95); 
            backdrop-filter: blur(25px); display: flex; justify-content: space-around; 
            padding-bottom: env(safe-area-inset-bottom); height: 60px;
            border-top: 1px solid rgba(255,255,255,0.1); z-index: 1000;
        }
        .tab-btn { background: none; border: none; color: var(--text-dim); text-align: center; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .tab-btn.active { color: var(--accent); }
        .tab-ico { font-size: 24px; }
        .tab-btn span { font-size: 11px; font-weight: 700; margin-top: 2px; }

        /* FORMLAR */
        .input-std { width: 100%; background: #2c2c2e; border: 1px solid #3a3a3c; padding: 16px; border-radius: 14px; color: white; margin-bottom: 12px; box-sizing: border-box; font-size: 16px; outline: none; }
        .btn-primary { width: 100%; background: var(--accent); color: white; border: none; padding: 18px; border-radius: 15px; font-weight: 700; font-size: 16px; }

        .hidden { display: none !important; }
        
        .progress-bar { height: 10px; background: #2c2c2e; border-radius: 5px; overflow: hidden; display: flex; margin: 15px 0; }
        .progress-fill { height: 100%; transition: 1s ease; }
    </style>
</head>
<body id="main-body">

    <div id="toast-container"></div>

    <div class="header"><h1>K√ºt√ºphanem üìö</h1></div>

    <div id="page-library">
        <div class="main-stats">
            <div class="stat-box"><b id="main-total-count">0</b><span style="font-size: 10px; color: var(--text-dim);">Kƒ∞TAP</span></div>
            <div class="stat-box"><b id="main-author-count">0</b><span style="font-size: 10px; color: var(--text-dim);">YAZAR</span></div>
        </div>
        <div class="controls"><input type="text" id="search-input" class="search-box" placeholder="Hƒ±zlƒ±ca ara..." onkeyup="applyFilters()"></div>
        <div class="container" id="book-list"></div>
    </div>

    <div id="page-authors" class="container hidden" style="margin-top: 20px;">
        <div id="authors-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
    </div>

    <div id="page-profile" class="container hidden" style="margin-top: 20px;">
        <div style="text-align:center; margin-bottom: 30px;">
            <div style="width: 80px; height: 80px; background: var(--accent); border-radius: 50%; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center; font-size: 30px;">üë§</div>
            <h2 style="margin:0;">ƒ∞statistiklerim</h2>
        </div>
        <div style="background: var(--card-bg); padding: 20px; border-radius: 20px;">
            <div class="progress-bar">
                <div id="bar-read" class="progress-fill" style="background:var(--success); width: 0%"></div>
                <div id="bar-reading" class="progress-fill" style="background:var(--accent); width: 0%"></div>
                <div id="bar-todo" class="progress-fill" style="background:var(--warning); width: 0%"></div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:700;">
                <span style="color:var(--success)">Bƒ∞TTƒ∞: <span id="stat-read-val">0</span></span>
                <span style="color:var(--accent)">OKUYOR: <span id="stat-reading-val">0</span></span>
                <span style="color:var(--warning)">BEKLƒ∞YOR: <span id="stat-todo-val">0</span></span>
            </div>
        </div>
        <button class="btn-primary" style="margin-top:20px; background:#2c2c2e;" onclick="pickRandomBook()">üé≤ Rastgele Kitap Se√ß</button>
    </div>

    <div id="page-login" class="container hidden" style="text-align: center; padding-top: 50px;">
        <div style="font-size: 40px; margin-bottom: 20px;">üîê</div>
        <input type="number" id="pin-input" placeholder="≈ûifre girin" inputmode="numeric" class="input-std" style="text-align:center; width: 160px;">
        <button class="btn-primary" onclick="checkLogin()">Giri≈ü Yap</button>
    </div>

    <div id="page-add" class="container hidden" style="padding-top: 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3>Yeni Kitap Ekle</h3>
            <span onclick="logout()" style="color:var(--danger); font-weight:bold; cursor:pointer;">√áIKI≈û</span>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="number" id="isbn-input" class="input-std" placeholder="ISBN Barkod" inputmode="numeric" style="margin:0;">
            <button onclick="fetchByISBN()" style="background:var(--warning); border:none; border-radius:14px; width:60px; font-size:24px;">ü™Ñ</button>
        </div>
        <input type="text" id="title-input" placeholder="Kitap Adƒ±" class="input-std">
        <input type="text" id="author-input" placeholder="Yazar Adƒ±" class="input-std">
        <button id="save-btn" class="btn-primary" onclick="saveBook()">RAFA EKLE</button>
    </div>

    <div id="detail-modal" class="modal-overlay" onclick="closeModal(event, 'detail-modal')">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div id="detail-modal-body"></div>
            <div style="display:flex; gap:10px; margin-top:30px;">
                <button class="btn-primary" style="background:var(--warning); color:black; flex:1;" onclick="updateBookStatus('todo')">Bekliyor</button>
                <button class="btn-primary" style="background:var(--accent); flex:1;" onclick="updateBookStatus('reading')">Okuyor</button>
                <button class="btn-primary" style="background:var(--success); color:black; flex:1;" onclick="updateBookStatus('read')">Okundu</button>
            </div>
        </div>
    </div>

    <div id="author-modal" class="modal-overlay" onclick="closeModal(event, 'author-modal')">
        <div class="modal-content"><div class="modal-drag-handle"></div><div id="author-modal-body"></div></div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" id="tab-library" onclick="switchTab('library')"><span class="tab-ico">üìö</span><span>Kitaplƒ±k</span></button>
        <button class="tab-btn" id="tab-authors" onclick="switchTab('authors')"><span class="tab-ico">üë§</span><span>Yazarlar</span></button>
        <button class="tab-btn" id="tab-profile" onclick="switchTab('profile')"><span class="tab-ico">üìä</span><span>Profil</span></button>
        <button class="tab-btn" id="tab-add" onclick="switchTab('add')"><span class="tab-ico">‚ûï</span><span>Ekle</span></button>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycby7oenOOtjnNkDTQs7G8HdaLkekcQyhhutWpELd_6LtAJ-qc9J6qnUQvthCWVgmzuqibg/exec";
        const ADMIN_PIN = "5555";
        let allBooks = [];
        let bookStatuses = {};
        let currentDetailBook = null;
        let isLoggedIn = false;

        window.onload = function() {
            const savedStatuses = localStorage.getItem('kutuphanem_statuses');
            if (savedStatuses) bookStatuses = JSON.parse(savedStatuses);
            const cached = localStorage.getItem('kutuphanem_data');
            if (cached) { allBooks = JSON.parse(cached); refreshUI(); }
            fetchBooks();
        };

        function cleanText(text) {
            return text.toString()
                .trim()
                .toLowerCase()
                .replace(/ƒ±/g, 'i')
                .replace(/ƒü/g, 'g')
                .replace(/√º/g, 'u')
                .replace(/≈ü/g, 's')
                .replace(/√∂/g, 'o')
                .replace(/√ß/g, 'c');
        }

        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 3500);
        }

        function fetchBooks() {
            fetch(API_URL).then(res => res.json()).then(data => {
                allBooks = data.map(b => ({ ad: b.ad.trim(), yazar: b.yazar.trim() }))
                               .sort((a,b) => a.ad.localeCompare(b.ad, 'tr'));
                localStorage.setItem('kutuphanem_data', JSON.stringify(allBooks));
                refreshUI();
            });
        }

        function refreshUI() {
            document.getElementById('main-total-count').innerText = allBooks.length;
            document.getElementById('main-author-count').innerText = new Set(allBooks.map(b => b.yazar)).size;
            
            let stats = { todo: 0, reading: 0, read: 0 };
            allBooks.forEach(b => {
                const s = bookStatuses[`${b.ad}-${b.yazar}`];
                if (s) stats[s]++;
            });

            document.getElementById('stat-read-val').innerText = stats.read;
            document.getElementById('stat-reading-val').innerText = stats.reading;
            document.getElementById('stat-todo-val').innerText = stats.todo;

            const total = allBooks.length;
            if (total > 0) {
                document.getElementById('bar-read').style.width = (stats.read / total * 100) + "%";
                document.getElementById('bar-reading').style.width = (stats.reading / total * 100) + "%";
                document.getElementById('bar-todo').style.width = (stats.todo / total * 100) + "%";
            }
            applyFilters();
            renderAuthorsPage();
        }

        function applyFilters() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const filtered = allBooks.filter(b => b.ad.toLowerCase().includes(q) || b.yazar.toLowerCase().includes(q));
            renderBooks(filtered);
        }

        function renderBooks(bks) {
            const list = document.getElementById('book-list');
            list.innerHTML = '';
            bks.forEach(b => {
                const status = bookStatuses[`${b.ad}-${b.yazar}`] || "";
                const dotColor = status === 'read' ? '#32d74b' : (status === 'reading' ? '#0a84ff' : (status === 'todo' ? '#ffd60a' : 'transparent'));
                const div = document.createElement('div');
                div.className = 'book-item';
                div.onclick = () => showBookDetail(b);
                div.innerHTML = `
                    <div style="width:40px;height:40px;background:#2c2c2e;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;">üìñ</div>
                    <div class="book-info">
                        <div class="book-title">${b.ad}</div>
                        <div class="book-author">${b.yazar}</div>
                    </div>
                    <div style="width:10px;height:10px;border-radius:50%;background:${dotColor};box-shadow: 0 0 10px ${dotColor};"></div>
                `;
                list.appendChild(div);
            });
        }

        function showBookDetail(b) {
            currentDetailBook = b;
            const body = document.getElementById('detail-modal-body');
            body.innerHTML = '<div style="padding:40px;text-align:center;">Bilgiler alƒ±nƒ±yor...</div>';
            toggleModal('detail-modal', true);

            fetch(`https://www.googleapis.com/books/v1/volumes?q=intitle:${b.ad}+inauthor:${b.yazar}&maxResults=1`)
            .then(res => res.json()).then(data => {
                let img = '', pc = '-', yr = '-', ds = 'Detay bulunamadƒ±.';
                if (data.items) {
                    const i = data.items[0].volumeInfo;
                    img = i.imageLinks?.thumbnail.replace('http:', 'https:') || '';
                    pc = i.pageCount || '-';
                    yr = i.publishedDate?.substring(0,4) || '-';
                    ds = i.description || ds;
                }
                body.innerHTML = `
                    <div style="text-align:center;">
                        ${img ? `<img src="${img}" style="width:130px; border-radius:15px; box-shadow: 0 15px 40px rgba(0,0,0,0.6);">` : '<div style="width:100px;height:150px;background:#2c2c2e;margin:0 auto;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:40px;">üìö</div>'}
                        <h2 style="margin:20px 0 5px 0; font-size:22px;">${b.ad}</h2>
                        <p style="color:var(--text-dim); font-size:16px; margin:0;">${b.yazar}</p>
                    </div>
                    <div style="display:flex; justify-content:center; gap:30px; margin:25px 0;">
                        <div style="text-align:center;"><b style="font-size:18px;">${pc}</b><br><small style="color:var(--text-dim)">SAYFA</small></div>
                        <div style="text-align:center;"><b style="font-size:18px;">${yr}</b><br><small style="color:var(--text-dim)">BASIM</small></div>
                    </div>
                    <div style="background:#2c2c2e; padding:20px; border-radius:20px; font-size:15px; line-height:1.6; color:#ccc; max-height:200px; overflow-y:auto;">${ds}</div>
                `;
            });
        }

        function updateBookStatus(status) {
            const key = `${currentDetailBook.ad}-${currentDetailBook.yazar}`;
            if (bookStatuses[key] === status) delete bookStatuses[key];
            else bookStatuses[key] = status;
            localStorage.setItem('kutuphanem_statuses', JSON.stringify(bookStatuses));
            showToast("Durum g√ºncellendi ‚ú®");
            toggleModal('detail-modal', false);
            refreshUI();
        }

        // --- AKILLI KAYIT (Kitap ƒ∞smi Onaylƒ±) ---
        function saveBook() {
            const adGiris = document.getElementById('title-input').value.trim();
            const yazarGiris = document.getElementById('author-input').value.trim();

            if (!adGiris || !yazarGiris) { 
                showToast("L√ºtfen t√ºm alanlarƒ± doldurun", "error"); 
                return; 
            }

            // 1. TAM E≈ûLE≈ûME (Aynƒ± Kitap + Aynƒ± Yazar)
            const tamEslesme = allBooks.find(b => 
                cleanText(b.ad) === cleanText(adGiris) && 
                cleanText(b.yazar) === cleanText(yazarGiris)
            );

            if (tamEslesme) {
                showToast(`‚ö†Ô∏è "${adGiris}" kitabƒ± bu yazarla zaten kayƒ±tlƒ±!`, "warning");
                return;
            }

            // 2. Kƒ∞TAP ADI E≈ûLE≈ûMESƒ∞ (Farklƒ± Yazar)
            const kitapEslesme = allBooks.find(b => cleanText(b.ad) === cleanText(adGiris));
            if (kitapEslesme) {
                const onay = confirm(`"${adGiris}" isimli bir kitap k√ºt√ºphanenizde zaten var (Yazar: ${kitapEslesme.yazar}). \n\nYine de bu yeni yazarla kaydetmek istiyor musunuz?`);
                if (!onay) return;
            }

            const btn = document.getElementById('save-btn');
            btn.disabled = true; btn.innerText = "Kaydediliyor...";

            fetch(API_URL, { method: 'POST', body: JSON.stringify({ ad: adGiris, yazar: yazarGiris }) })
            .then(() => {
                showToast("Kitap rafa eklendi üéâ");
                document.getElementById('title-input').value = '';
                document.getElementById('author-input').value = '';
                document.getElementById('isbn-input').value = '';
                fetchBooks();
            }).catch(() => showToast("Hata olu≈ütu", "error"))
            .finally(() => { btn.disabled = false; btn.innerText = "RAFA EKLE"; });
        }

        function fetchByISBN() {
            const i = document.getElementById('isbn-input').value;
            if (i.length < 5) return;
            showToast("Barkod sorgulanƒ±yor... ‚è≥");
            fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${i}`).then(res => res.json()).then(data => {
                if (data.items) {
                    const v = data.items[0].volumeInfo;
                    document.getElementById('title-input').value = v.title;
                    document.getElementById('author-input').value = v.authors ? v.authors[0] : "";
                    showToast("Kitap bilgileri bulundu ü™Ñ");
                } else showToast("Barkod bulunamadƒ±", "error");
            });
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + t).classList.add('active');
            ['page-library', 'page-authors', 'page-profile', 'page-login', 'page-add'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if (t === 'add' && !isLoggedIn) document.getElementById('page-login').classList.remove('hidden');
            else document.getElementById('page-' + t).classList.remove('hidden');
        }

        function checkLogin() { if(document.getElementById('pin-input').value === ADMIN_PIN) { isLoggedIn = true; switchTab('add'); showToast("Giri≈ü yapƒ±ldƒ± üîê"); } else showToast("Hatalƒ± ≈üifre!", "error"); }
        function logout() { isLoggedIn = false; switchTab('library'); }
        function toggleModal(id, s) { document.getElementById(id).style.display = s ? 'flex' : 'none'; }
        function closeModal(e, id) { if(e.target.id === id) toggleModal(id, false); }
        function renderAuthorsPage() { const grid = document.getElementById('authors-grid'); grid.innerHTML = ''; const g = {}; allBooks.forEach(b => { if(!g[b.yazar]) g[b.yazar]=[]; g[b.yazar].push(b); }); Object.keys(g).sort().forEach(a => { const div = document.createElement('div'); div.className='author-tile'; div.onclick=()=>openAuthorBooks(a, g[a]); div.innerHTML=`<div class="tile-name">${a}</div><div style="font-size:12px; color:var(--accent); font-weight:800;">${g[a].length} Kitap</div>`; grid.appendChild(div); }); }
        function openAuthorBooks(a, bks) { const b = document.getElementById('author-modal-body'); b.innerHTML=`<h2 style="text-align:center">${a}</h2>`; bks.forEach(bk=>{ const div = document.createElement('div'); div.className='book-item'; div.onclick=()=>showBookDetail(bk); div.innerHTML=`<div style="width:40px;height:40px;background:#2c2c2e;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;">üìñ</div><div class="book-info"><div class="book-title">${bk.ad}</div></div>`; b.appendChild(div); }); toggleModal('author-modal', true); }
        function pickRandomBook() { if(allBooks.length===0) return; const b = allBooks[Math.floor(Math.random()*allBooks.length)]; showBookDetail(b); }
    </script>
</body>
</html>
